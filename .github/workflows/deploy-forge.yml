name: Deploy to Forge

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'examples/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build docs
        run: |
          npm ci
          npm run docs:build

      - name: Deploy to web directory
        run: |
          sudo rm -rf /var/www/quantum.sargas.cloud/*
          sudo cp -r docs/.vitepress/dist/* /var/www/quantum.sargas.cloud/
          sudo chown -R www-data:www-data /var/www/quantum.sargas.cloud/
          echo "Docs deployed!"

      - name: Update nginx config
        run: |
          echo "=== All nginx configs ==="
          ls -la /etc/nginx/sites-enabled/
          echo ""
          echo "=== Main nginx.conf includes ==="
          grep -E "include|sites-enabled" /etc/nginx/nginx.conf || true
          echo ""
          echo "=== Port 80 config (Forge managed?) ==="
          sudo grep -r "listen 80" /etc/nginx/ 2>/dev/null | head -10 || true
          echo ""
          echo "=== Port 443 config ==="
          sudo grep -r "listen 443" /etc/nginx/ 2>/dev/null | head -10 || true
          echo ""
          echo "=== Forge site config ==="
          cat /etc/nginx/sites-available/quantum.sargas.cloud 2>/dev/null || true
          echo "Done!"
