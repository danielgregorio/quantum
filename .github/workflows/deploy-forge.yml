name: Deploy to Forge

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'examples/**'
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Build docs
        run: |
          npm ci
          npm run docs:build

      - name: Deploy to web directory
        run: |
          sudo rm -rf /var/www/quantum.sargas.cloud/*
          sudo cp -r docs/.vitepress/dist/* /var/www/quantum.sargas.cloud/
          sudo chown -R www-data:www-data /var/www/quantum.sargas.cloud/
          echo "Docs deployed!"

      - name: Update nginx config
        run: |
          echo "=== Debug: List sites-enabled symlinks ==="
          ls -la /etc/nginx/sites-enabled/ || true

          echo "=== Creating docs-only nginx config ==="
          sudo tee /etc/nginx/sites-available/quantum.sargas.cloud > /dev/null << 'NGINX'
          # Quantum Documentation Site - VitePress
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name quantum.sargas.cloud localhost _;

              root /var/www/quantum.sargas.cloud;
              index index.html;

              location / {
                  try_files $uri $uri/ =404;
              }

              # Cache static assets
              location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
                  expires 30d;
                  add_header Cache-Control "public, immutable";
              }

              error_page 404 /404.html;
          }
          NGINX

          echo "=== Ensure symlink exists ==="
          sudo ln -sf /etc/nginx/sites-available/quantum.sargas.cloud /etc/nginx/sites-enabled/quantum.sargas.cloud

          echo "=== Remove any conflicting default config ==="
          sudo rm -f /etc/nginx/sites-enabled/default 2>/dev/null || true

          echo "=== Testing nginx ==="
          sudo nginx -t

          echo "=== Reloading nginx ==="
          sudo systemctl reload nginx

          echo "=== Check main nginx config ==="
          cat /etc/nginx/nginx.conf | grep -A5 "http {" || true

          echo "=== Check for SSL config ==="
          ls -la /etc/nginx/sites-enabled/
          cat /etc/nginx/sites-enabled/quantum.sargas.cloud || true

          echo "=== Verification ==="
          echo "Homepage:"
          curl -s http://localhost/ | head -3
          echo ""
          echo "File permissions on /var/www/quantum.sargas.cloud:"
          ls -la /var/www/quantum.sargas.cloud/ | head -10
          echo ""
          echo "File permissions on examples dir:"
          ls -la /var/www/quantum.sargas.cloud/examples/ | head -5
          echo ""
          echo "Can nginx user read the file?"
          sudo -u www-data cat /var/www/quantum.sargas.cloud/examples/index.html | head -3
          echo ""
          echo "Direct file access (examples/index.html):"
          curl -s http://localhost/examples/index.html | head -3
          echo ""
          echo "Examples page (with trailing slash):"
          curl -s http://localhost/examples/ | head -3
          echo ""
          echo "Done!"
