<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Execution - Quantum Admin</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="testRunner()" x-cloak class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Test Execution</h1>
                        <p class="text-sm text-gray-500 mt-1">Run and monitor Quantum Language tests</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/frontend/index.html" class="text-sm text-gray-600 hover:text-gray-900">← Back to Projects</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Error Alert -->
            <div x-show="error" class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-red-800" x-text="error"></p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button @click="error = null" class="text-red-400 hover:text-red-600">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Project Selector -->
            <div class="bg-white rounded-lg shadow mb-8 p-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Project</label>
                <select x-model="selectedProjectId" @change="onProjectChange()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    <option value="">-- Select a project --</option>
                    <template x-for="project in projects" :key="project.id">
                        <option :value="project.id" x-text="project.name"></option>
                    </template>
                </select>
            </div>

            <!-- Run Tests Section -->
            <div x-show="selectedProjectId" class="bg-white rounded-lg shadow mb-8">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-lg font-semibold text-gray-900">Run Tests</h2>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Suite Filter (Optional)</label>
                            <select x-model="testConfig.suite_filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">All Suites</option>
                                <option value="conditionals">Conditionals</option>
                                <option value="loops">Loops</option>
                                <option value="databinding">Databinding</option>
                                <option value="state">State Management</option>
                                <option value="functions">Functions</option>
                                <option value="validation">Validation</option>
                                <option value="query">Database Query</option>
                                <option value="invoke">Invocation</option>
                                <option value="data">Data Import</option>
                                <option value="logging">Logging</option>
                                <option value="dump">Dump</option>
                                <option value="actions">Forms & Actions</option>
                                <option value="transactions">Transactions</option>
                                <option value="sessions">Sessions</option>
                                <option value="authentication">Authentication</option>
                                <option value="uploads">File Uploads</option>
                                <option value="emails">Email Sending</option>
                                <option value="htmx">HTMX Partials</option>
                                <option value="islands">Islands Architecture</option>
                            </select>
                        </div>
                        <div class="flex items-center">
                            <label class="inline-flex items-center">
                                <input type="checkbox" x-model="testConfig.verbose" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Verbose Output</span>
                            </label>
                        </div>
                        <div class="flex items-center">
                            <label class="inline-flex items-center">
                                <input type="checkbox" x-model="testConfig.stop_on_fail" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="ml-2 text-sm text-gray-700">Stop on Failure</span>
                            </label>
                        </div>
                    </div>
                    <button @click="runTests()" :disabled="running"
                            class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span x-show="!running">▶ Run Tests</span>
                        <span x-show="running">⏳ Running Tests...</span>
                    </button>
                </div>
            </div>

            <!-- Test Runs History -->
            <div x-show="selectedProjectId" class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Test Runs History</h2>
                    <button @click="loadTestRuns()" class="text-sm text-blue-600 hover:text-blue-800">Refresh</button>
                </div>

                <!-- Loading State -->
                <div x-show="loading" class="px-6 py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <p class="mt-2 text-sm text-gray-500">Loading test runs...</p>
                </div>

                <!-- Test Runs List -->
                <div x-show="!loading" class="divide-y divide-gray-200">
                    <template x-for="run in testRuns" :key="run.id">
                        <div class="px-6 py-4 hover:bg-gray-50 transition cursor-pointer" @click="viewTestRun(run.id)">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3">
                                        <span class="text-sm font-medium text-gray-900" x-text="'Run #' + run.id"></span>
                                        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium"
                                              :class="{
                                                  'bg-green-100 text-green-800': run.status === 'completed',
                                                  'bg-blue-100 text-blue-800': run.status === 'running',
                                                  'bg-red-100 text-red-800': run.status === 'failed',
                                                  'bg-yellow-100 text-yellow-800': run.status === 'cancelled',
                                                  'bg-gray-100 text-gray-800': run.status === 'error'
                                              }"
                                              x-text="run.status"></span>
                                        <span x-show="run.suite_filter" class="text-xs text-gray-500" x-text="'Suite: ' + run.suite_filter"></span>
                                    </div>
                                    <div class="mt-2 flex items-center space-x-6 text-sm text-gray-600">
                                        <div class="flex items-center space-x-2">
                                            <span class="font-medium">Total:</span>
                                            <span x-text="run.total_tests"></span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-green-600">
                                            <span class="font-medium">Passed:</span>
                                            <span x-text="run.passed_tests"></span>
                                        </div>
                                        <div class="flex items-center space-x-2 text-red-600">
                                            <span class="font-medium">Failed:</span>
                                            <span x-text="run.failed_tests"></span>
                                        </div>
                                        <div x-show="run.duration_seconds" class="flex items-center space-x-2 text-gray-500">
                                            <span class="font-medium">Duration:</span>
                                            <span x-text="run.duration_seconds + 's'"></span>
                                        </div>
                                    </div>
                                    <div class="mt-1 text-xs text-gray-400">
                                        <span x-text="'Started: ' + new Date(run.started_at).toLocaleString()"></span>
                                        <span x-show="run.triggered_by" x-text="' • Triggered by: ' + run.triggered_by"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Empty State -->
                    <div x-show="!loading && testRuns.length === 0" class="px-6 py-12 text-center">
                        <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No test runs yet</h3>
                        <p class="mt-1 text-sm text-gray-500">Run your first test to see results here.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Test Run Detail Modal -->
        <div x-show="showDetailModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
                <div class="fixed inset-0 transition-opacity bg-gray-500 bg-opacity-75" @click="showDetailModal = false"></div>

                <div class="inline-block w-full max-w-4xl px-4 pt-5 pb-4 overflow-hidden text-left align-bottom transition-all transform bg-white rounded-lg shadow-xl sm:my-8 sm:align-middle sm:p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-medium text-gray-900" x-text="selectedRun ? 'Test Run #' + selectedRun.id : 'Test Run Details'"></h3>
                        <button @click="showDetailModal = false" class="text-gray-400 hover:text-gray-500">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                        </button>
                    </div>

                    <template x-if="selectedRun">
                        <div>
                            <!-- Summary -->
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                                    <div>
                                        <span class="block text-gray-500">Status</span>
                                        <span class="block font-medium mt-1" x-text="selectedRun.status"></span>
                                    </div>
                                    <div>
                                        <span class="block text-gray-500">Total Tests</span>
                                        <span class="block font-medium mt-1" x-text="selectedRun.total_tests"></span>
                                    </div>
                                    <div>
                                        <span class="block text-gray-500 text-green-600">Passed</span>
                                        <span class="block font-medium mt-1 text-green-600" x-text="selectedRun.passed_tests"></span>
                                    </div>
                                    <div>
                                        <span class="block text-gray-500 text-red-600">Failed</span>
                                        <span class="block font-medium mt-1 text-red-600" x-text="selectedRun.failed_tests"></span>
                                    </div>
                                </div>
                            </div>

                            <!-- Test Results -->
                            <div class="max-h-96 overflow-y-auto">
                                <h4 class="text-sm font-medium text-gray-700 mb-2">Individual Test Results</h4>
                                <div class="space-y-2">
                                    <template x-for="result in selectedRun.test_results" :key="result.id">
                                        <div class="border border-gray-200 rounded-lg p-3">
                                            <div class="flex items-start justify-between">
                                                <div class="flex-1">
                                                    <div class="flex items-center space-x-2">
                                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium"
                                                              :class="result.status === 'passed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'"
                                                              x-text="result.status.toUpperCase()"></span>
                                                        <span class="text-sm font-medium text-gray-900" x-text="result.test_file"></span>
                                                    </div>
                                                    <div class="mt-1 text-xs text-gray-500">
                                                        <span x-text="'Suite: ' + result.suite_name"></span>
                                                        <span x-show="result.duration_seconds" x-text="' • Duration: ' + result.duration_seconds + 's'"></span>
                                                    </div>
                                                    <div x-show="result.error_message" class="mt-2 text-xs text-red-600 bg-red-50 p-2 rounded">
                                                        <span class="font-medium">Error:</span>
                                                        <pre class="mt-1 whitespace-pre-wrap" x-text="result.error_message"></pre>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <script>
        function testRunner() {
            return {
                apiUrl: 'http://localhost:8000',
                projects: [],
                selectedProjectId: '',
                testRuns: [],
                selectedRun: null,
                showDetailModal: false,
                loading: false,
                running: false,
                error: null,
                pollingInterval: null,
                testConfig: {
                    suite_filter: '',
                    verbose: false,
                    stop_on_fail: false,
                    triggered_by: 'manual'
                },

                async init() {
                    await this.loadProjects();
                    // Check if project ID is in URL
                    const urlParams = new URLSearchParams(window.location.search);
                    const projectId = urlParams.get('project');
                    if (projectId) {
                        this.selectedProjectId = projectId;
                        await this.onProjectChange();
                    }
                },

                async loadProjects() {
                    try {
                        const response = await fetch(`${this.apiUrl}/projects`);
                        if (response.ok) {
                            this.projects = await response.json();
                        }
                    } catch (e) {
                        this.error = 'Failed to load projects: ' + e.message;
                    }
                },

                async onProjectChange() {
                    if (this.selectedProjectId) {
                        await this.loadTestRuns();
                        this.startPolling();
                    } else {
                        this.stopPolling();
                    }
                },

                async loadTestRuns() {
                    if (!this.selectedProjectId) return;

                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/projects/${this.selectedProjectId}/tests/runs`);
                        if (response.ok) {
                            this.testRuns = await response.json();
                        } else {
                            this.error = 'Failed to load test runs';
                        }
                    } catch (e) {
                        this.error = 'Error loading test runs: ' + e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async runTests() {
                    if (!this.selectedProjectId) {
                        this.error = 'Please select a project first';
                        return;
                    }

                    this.running = true;
                    this.error = null;

                    try {
                        const response = await fetch(`${this.apiUrl}/projects/${this.selectedProjectId}/tests/run`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                suite_filter: this.testConfig.suite_filter || null,
                                verbose: this.testConfig.verbose,
                                stop_on_fail: this.testConfig.stop_on_fail,
                                triggered_by: this.testConfig.triggered_by
                            })
                        });

                        if (response.ok) {
                            const testRun = await response.json();
                            await this.loadTestRuns();
                            // Scroll to top to show the new run
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                        } else {
                            const error = await response.json();
                            this.error = 'Failed to run tests: ' + (error.detail || 'Unknown error');
                        }
                    } catch (e) {
                        this.error = 'Error running tests: ' + e.message;
                    } finally {
                        this.running = false;
                    }
                },

                async viewTestRun(runId) {
                    try {
                        const response = await fetch(`${this.apiUrl}/projects/${this.selectedProjectId}/tests/runs/${runId}`);
                        if (response.ok) {
                            this.selectedRun = await response.json();
                            this.showDetailModal = true;
                        }
                    } catch (e) {
                        this.error = 'Error loading test run details: ' + e.message;
                    }
                },

                startPolling() {
                    this.stopPolling();
                    this.pollingInterval = setInterval(() => {
                        // Only poll if we have a project selected
                        if (this.selectedProjectId && !this.loading) {
                            this.loadTestRuns();
                        }
                    }, 5000); // Poll every 5 seconds
                },

                stopPolling() {
                    if (this.pollingInterval) {
                        clearInterval(this.pollingInterval);
                        this.pollingInterval = null;
                    }
                }
            }
        }
    </script>
</body>
</html>
