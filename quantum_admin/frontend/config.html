<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuration - Quantum Admin</title>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        [x-cloak] { display: none !important; }
    </style>
</head>
<body class="bg-gray-50">
    <div x-data="configManager()" x-cloak class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">Configuration Management</h1>
                        <p class="text-sm text-gray-500 mt-1">Manage environment variables and secrets</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <a href="/frontend/index.html" class="text-sm text-gray-600 hover:text-gray-900">← Back</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Error Alert -->
            <div x-show="error" class="mb-6 bg-red-50 border border-red-200 rounded-lg p-4">
                <div class="flex">
                    <div class="ml-3">
                        <p class="text-sm text-red-800" x-text="error"></p>
                    </div>
                    <div class="ml-auto pl-3">
                        <button @click="error = null" class="text-red-400 hover:text-red-600">×</button>
                    </div>
                </div>
            </div>

            <!-- Project Selector -->
            <div class="bg-white rounded-lg shadow mb-8 p-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Select Project</label>
                <select x-model="selectedProjectId" @change="onProjectChange()" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">-- Select a project --</option>
                    <template x-for="project in projects" :key="project.id">
                        <option :value="project.id" x-text="project.name"></option>
                    </template>
                </select>
            </div>

            <!-- Environment Variables -->
            <div x-show="selectedProjectId" class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200 flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Environment Variables</h2>
                    <button @click="showCreateModal = true" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                        + Add Variable
                    </button>
                </div>

                <div x-show="loading" class="px-6 py-12 text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                </div>

                <div x-show="!loading" class="divide-y divide-gray-200">
                    <template x-for="env in envVars" :key="env.id">
                        <div class="px-6 py-4 hover:bg-gray-50">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3">
                                        <span class="font-medium text-gray-900" x-text="env.key"></span>
                                        <span x-show="env.is_secret" class="px-2 py-0.5 bg-red-100 text-red-800 text-xs rounded">SECRET</span>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-1" x-text="env.description || 'No description'"></p>
                                    <p class="text-sm text-gray-500 font-mono mt-2" x-text="env.value_masked"></p>
                                </div>
                                <button @click="deleteEnvVar(env.key)" class="ml-4 text-red-600 hover:text-red-800">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </template>

                    <div x-show="!loading && envVars.length === 0" class="px-6 py-12 text-center">
                        <p class="text-gray-500">No environment variables yet. Click "Add Variable" to create one.</p>
                    </div>
                </div>
            </div>
        </main>

        <!-- Create Modal -->
        <div x-show="showCreateModal" class="fixed inset-0 z-50 overflow-y-auto" style="display: none;">
            <div class="flex items-center justify-center min-h-screen px-4">
                <div class="fixed inset-0 bg-gray-500 bg-opacity-75" @click="showCreateModal = false"></div>

                <div class="relative bg-white rounded-lg shadow-xl max-w-md w-full p-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Add Environment Variable</h3>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Key</label>
                            <input x-model="newEnvVar.key" type="text" placeholder="DATABASE_URL"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Value</label>
                            <input x-model="newEnvVar.value" type="text" placeholder="your-value-here"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                            <input x-model="newEnvVar.description" type="text" placeholder="Optional description"
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        </div>

                        <div class="flex items-center">
                            <input x-model="newEnvVar.is_secret" type="checkbox" class="rounded border-gray-300">
                            <label class="ml-2 text-sm text-gray-700">Mark as secret (masks value)</label>
                        </div>
                    </div>

                    <div class="mt-6 flex space-x-3">
                        <button @click="createEnvVar()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                            Create
                        </button>
                        <button @click="showCreateModal = false" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function configManager() {
            return {
                apiUrl: 'http://localhost:8000',
                projects: [],
                selectedProjectId: '',
                envVars: [],
                loading: false,
                error: null,
                showCreateModal: false,
                newEnvVar: {
                    key: '',
                    value: '',
                    description: '',
                    is_secret: false
                },

                async init() {
                    await this.loadProjects();
                    const urlParams = new URLSearchParams(window.location.search);
                    const projectId = urlParams.get('project');
                    if (projectId) {
                        this.selectedProjectId = projectId;
                        await this.onProjectChange();
                    }
                },

                async loadProjects() {
                    try {
                        const response = await fetch(`${this.apiUrl}/projects`);
                        if (response.ok) {
                            this.projects = await response.json();
                        }
                    } catch (e) {
                        this.error = 'Failed to load projects: ' + e.message;
                    }
                },

                async onProjectChange() {
                    if (this.selectedProjectId) {
                        await this.loadEnvVars();
                    }
                },

                async loadEnvVars() {
                    this.loading = true;
                    try {
                        const response = await fetch(`${this.apiUrl}/projects/${this.selectedProjectId}/environment-variables`);
                        if (response.ok) {
                            this.envVars = await response.json();
                        } else {
                            this.error = 'Failed to load environment variables';
                        }
                    } catch (e) {
                        this.error = 'Error loading environment variables: ' + e.message;
                    } finally {
                        this.loading = false;
                    }
                },

                async createEnvVar() {
                    if (!this.newEnvVar.key || !this.newEnvVar.value) {
                        this.error = 'Key and value are required';
                        return;
                    }

                    try {
                        const response = await fetch(`${this.apiUrl}/projects/${this.selectedProjectId}/environment-variables`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.newEnvVar)
                        });

                        if (response.ok) {
                            this.showCreateModal = false;
                            this.newEnvVar = { key: '', value: '', description: '', is_secret: false };
                            await this.loadEnvVars();
                        } else {
                            const error = await response.json();
                            this.error = 'Failed to create variable: ' + (error.detail || 'Unknown error');
                        }
                    } catch (e) {
                        this.error = 'Error creating variable: ' + e.message;
                    }
                },

                async deleteEnvVar(key) {
                    if (!confirm(`Delete environment variable "${key}"?`)) return;

                    try {
                        const response = await fetch(`${this.apiUrl}/projects/${this.selectedProjectId}/environment-variables/${key}`, {
                            method: 'DELETE'
                        });

                        if (response.ok) {
                            await this.loadEnvVars();
                        } else {
                            this.error = 'Failed to delete variable';
                        }
                    } catch (e) {
                        this.error = 'Error deleting variable: ' + e.message;
                    }
                }
            }
        }
    </script>
</body>
</html>
